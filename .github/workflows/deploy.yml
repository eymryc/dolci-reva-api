name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PHP_VERSION: '8.2'

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, bcmath, pdo, pdo_mysql, fileinfo, gd, curl, zip, intl, exif
          coverage: none
      
      - name: Get Composer Cache Directory
        id: composer-cache
        shell: bash
        run: |
          echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: |
          composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader --no-dev
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install NPM dependencies
        run: npm ci
      
      - name: Build assets
        run: npm run build
      
      - name: Create deployment package
        run: |
          mkdir -p deployment
          tar -czf deployment.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env*' \
            --exclude='*.md' \
            --exclude='phpunit.xml' \
            --exclude='vite.config.js' \
            --exclude='package*.json' \
            --exclude='.gitignore' \
            .
      
      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment.tar.gz
          retention-days: 7
      
      # D√©ploiement sur cPanel via SSH
      - name: Deploy to cPanel server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_PATH: /home/achalivr/public_html/dolci-reva.achalivre-afrique.ci
        run: |
          # Cr√©er le fichier de cl√© SSH
          echo "$DEPLOY_KEY" > deploy_key
          chmod 600 deploy_key
          
          # Tester la connexion SSH
          echo "üîç Testing SSH connection..."
          ssh -i deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $DEPLOY_USER@$DEPLOY_HOST "echo 'SSH connection successful'"
          
          # Cr√©er le r√©pertoire de d√©ploiement si n√©cessaire
          echo "üìÅ Creating deployment directory..."
          ssh -i deploy_key -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $DEPLOY_PATH"
          
          # Transf√©rer le package de d√©ploiement
          echo "üì¶ Uploading deployment package..."
          scp -i deploy_key -o StrictHostKeyChecking=no deployment.tar.gz $DEPLOY_USER@$DEPLOY_HOST:/tmp/deployment.tar.gz
          
          # Extraire et d√©ployer sur le serveur
          echo "üöÄ Deploying to server..."
          ssh -i deploy_key -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST bash << 'ENDSSH'
            set -e
            DEPLOY_PATH="/home/achalivr/public_html/dolci-reva.achalivre-afrique.ci"
            cd "$DEPLOY_PATH" || exit 1
            
            # Sauvegarder le .env existant
            if [ -f .env ]; then
              echo "üíæ Backing up .env file..."
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # Extraire le nouveau code
            echo "üìÇ Extracting files..."
            tar -xzf /tmp/deployment.tar.gz -C "$DEPLOY_PATH" --strip-components=0 || {
              echo "‚ùå Error extracting files"
              exit 1
            }
            
            # Restaurer le .env si sauvegard√©
            if ls .env.backup.* 1> /dev/null 2>&1; then
              echo "üîÑ Restoring .env file..."
              mv .env.backup.* .env
            fi
            
            # V√©rifier que PHP est disponible
            if ! command -v php &> /dev/null; then
              echo "‚ö†Ô∏è PHP not found in PATH, trying /usr/bin/php..."
              PHP_CMD="/usr/bin/php"
            else
              PHP_CMD="php"
            fi
            
            # Optimiser Laravel
            echo "‚ö° Optimizing Laravel..."
            $PHP_CMD artisan config:cache || echo "‚ö†Ô∏è config:cache failed"
            $PHP_CMD artisan route:cache || echo "‚ö†Ô∏è route:cache failed"
            $PHP_CMD artisan view:cache || echo "‚ö†Ô∏è view:cache failed"
            
            # Ex√©cuter les migrations (optionnel - d√©commentez si n√©cessaire)
            # $PHP_CMD artisan migrate --force || echo "‚ö†Ô∏è migrate failed"
            
            # Nettoyer le cache
            echo "üßπ Clearing cache..."
            $PHP_CMD artisan cache:clear || echo "‚ö†Ô∏è cache:clear failed"
            
            # Nettoyer le fichier temporaire
            rm -f /tmp/deployment.tar.gz
            echo "‚úÖ Deployment completed successfully!"
          ENDSSH
          
          # Nettoyer la cl√© locale
          rm -f deploy_key
          echo "üîí SSH key cleaned up"
      
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi

